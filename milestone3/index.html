<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>CptS415 - Milestone 3</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  </head>
  <body>
    <div class="container-fluid bg-dark px-4 py-2 min-vh-100">
      <div class="row vh-33">
        <div class="col-3 location-container">
          <!-- Selectable by default -->
          <div class="dropdown">
            <button class="btn btn-dark dropdown-toggle" type="button" id="state" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Select a state
            </button>
            <div class="dropdown-menu scrollable-menu" id="sddm" aria-labelledby="state">
            </div>
          </div>
          <!-- Can select after state is chosen -->
          <div class="dropdown">
            <button class="btn btn-dark dropdown-toggle" type="button" id="city" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled>
              Select a city
            </button>
            <div class="dropdown-menu scrollable-menu" id="cddm" aria-labelledby="city">
            </div>
          </div>
          <!-- Can select after city is chosen -->
          <div class="dropdown">
            <button class="btn btn-dark dropdown-toggle" type="button" id="zip" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled>
              Select a zip
            </button>
            <div class="dropdown-menu scrollable-menu" id="zddm" aria-labelledby="zip">
            </div>
          </div>
        </div>
        <div class="col-3 stats-container">
          <div class="row">
            <div class="col-12">
              <div class="stats text-light bg-dark">
                <div class="b-container">
                  <span>Number of Businesses: <span id="b-count"></span></span>
                </div>
                <div class="p-container">
                  <span>Population: <span id="population"></span></span>
                </div>
                <div class="i-container">
                  <span>Average income: <span id="income"></span></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-6 stats-table-container">
          <table class="table table-dark">
            <thead>
              <tr>
                <th scope="col">Number of Businesses</th>
                <th scope="col">Category</th>
              </tr>
            </thead>
            <tbody id="c-table">
            </tbody>
          </table>
        </div>
      </div>

      <div class="row vh-33">
        <div class="col-2 cat-container">
          <div class="form-group text-light bg-dark">
            <div class="row">
              <div class="col-12">
                <label for="sel-cat">Select Category</label>
                </div>
            </div>
            <div class="row">
              <div class="col-12">
                <select multiple class="form-control text-light bg-dark" id="sel-cat" onclick="onCatClick()" disabled>
                  <option>Empty</option>
                </select>
              </div>
              <div class="col-12">
                <div class="row">
                  <div class="col-12">
                    <button type="button" class="btn btn-primary pull-right" onclick="onFilterClick()" id="filter-btn" disabled>
                      <span class="fa fa-filter fa-lg" aria-hidden="true"></span>
                    </button>
                    <button type="button" class="btn btn-warning pull-right" onclick="onClearClick()" id="clear-btn" disabled>
                      <span class="fa fa-remove fa-lg" aria-hidden="true"></span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-10 b-table-container">
          <div class="row text-light bg-dark">
            <div class="col-12">
              <label for="sel-cat">Businesses</label>
            </div>
            <table class="col-12 table table-dark">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">Name</th>
                  <th scope="col">Address</th>
                  <th scope="col">City</th>
                  <th scope="col">Stars</th>
                  <th scope="col">Reviews</th>
                  <th scope="col">Rating</th>
                  <th scope="col">Checkins</th>
                </tr>
              </thead>
              <tbody id="b-table">
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="row vh-33">
        <div class="col-1">
          <button type="button" class="btn btn-primary" onclick="onRefreshClick()" id="refresh-btn" disabled>
            <span class="fa fa-refresh fa-lg" aria-hidden="true"></span>
          </button>
        </div>
        <div class="col-4">
          <table class="table table-dark">
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Stars</th>
                <th scope="col">Reviews</th>
                <th scope="col">Rating</th>
                <th scope="col">Price</th>
              </tr>
            </thead>
            <tbody id="expensive">
            </tbody>
          </table>
        </div>
        <div class="col-4">
          <table class="table table-dark">
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Stars</th>
                <th scope="col">Rating</th>
                <th scope="col">Reviews</th>
              </tr>
            </thead>
            <tbody id="popular">
            </tbody>
          </table>
        </div>
        <div class="col-3">
          <table class="table table-dark">
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Reviews</th>
                <th scope="col">Checkins</th>
              </tr>
            </thead>
            <tbody id="successful">
            </tbody>
          </table>
        </div>
      </div>

    </div>
    <script src="{{ url_for('static', filename='jquery-3.3.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='popper.min.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
    <script type="text/javascript">
      var ustates;
      var ucities;
      var data = [];
      for (var i = 0; i < 100; i++) {
        data.push({
          'business': 'business' + i,
          'city': 'city' + i,
          'state': 'state' + i
        });
      }

      var state = null;
      var city = null;
      var business = null;

      <!-- On load, load states and fill states dropdown -->
      $(document).ready(function () {
        $.ajax({
          url: '/api/v1.0/states/',
          success: function (data, status) {
            s = "";
            for (var i = 0; i < data.states.length; i++) {
              s = s + `
                <a class="dropdown-item" href="#" onclick="onStateClick('${data.states[i]}')">${data.states[i]}</a>
              `;
            }
            $('#sddm').html(s);
          }
        });
      });

      function onStateClick(e) {
        state = e;
        $('#city').prop('disabled', false);
        $('#state').text(e);

        <!-- Send to endpoint -->
        $.ajax({
          url: `/api/v1.0/cities/${state}/`,
          success: function (data, status) {
            c = "";
            for (var i = 0; i < data.cities.length; i++) {
              c = c + `
                <a class="dropdown-item" href="#" onclick="onCityClick('${data.cities[i]}')">${data.cities[i]}</a>
              `;
            }
            $('#cddm').html(c);
            $('#city').text("Select a city");
          }
        });
      }

      function onCityClick(e) {
        city = e;
        $('#zip').prop('disabled', false);
        $('#city').text(e);

        <!-- Send to endpoint -->
        $.ajax({
          url: `/api/v1.0/zips/${state}/${city}/`,
          success: function (data, status) {
            c = "";
            for (var i = 0; i < data.zips.length; i++) {
              c = c + `
                <a class="dropdown-item" href="#" onclick="onZipClick('${data.zips[i][0]}')">${data.zips[i][0]}</a>
              `;
            }
            $('#zddm').html(c);
            $('#zip').text("Select a zip");
          }
        });
      }

      function onZipClick(e) {
        zip = e;
        $('#zip').text(e);

        <!-- Send to endpoint -->
        $.ajax({
          url: `/api/v1.0/businesses/${state}/${city}/${zip}`,
          success: function (data, status) {
            <!-- Use response to populate TABLE -->
            d = "";
            for (var i = 0; i < data.businesses.length; i++){
              td = "";
              for (var j = 0; j < data.businesses[i].length; j++){
                td = td + `<td>${data.businesses[i][j]}</td>`;
              }
              d = d + `
                <tr>
                  <th scope="row">${i+1}</th>
                  ${td}
                </tr>
              `;
            }
            $('#b-table').html(d);

            <!-- Send to endpoint -->
            $.ajax({
              url: `/api/v1.0/stats/${state}/${city}/${zip}`,
              success: function (d, s) {
                $('#b-count').html(d.stats[0][0]);
                $('#population').html(d.stats[0][1]);
                $('#income').html(d.stats[0][2]);

                <!-- Send to endpoint -->
                $.ajax({
                  url: `/api/v1.0/categories/${state}/${city}/${zip}`,
                  success: function (c, s) {
                    s = "";
                    for (var i = 0; i < c.categories.length; i++) {
                      s = s + `
                        <option>${c.categories[i][0]}</option>
                      `;
                    }
                    $('#sel-cat').html(s);
                    $('#sel-cat').prop('disabled', false);

                    <!-- Send to endpoint -->
                    $.ajax({
                      url: `/api/v1.0/cat-stats/${state}/${city}/${zip}`,
                      success: function (cs, status) {
                        <!-- Use response to populate TABLE -->
                        d = "";
                        for (var i = 0; i < cs.stats.length; i++){
                          td = "";
                          for (var j = 0; j < cs.stats[i].length; j++){
                            td = td + `<td>${cs.stats[i][j]}</td>`;
                          }
                          d = d + `
                            <tr>
                              ${td}
                            </tr>
                          `;
                        }
                        $('#c-table').html(d);

                        $('#refresh-btn').prop('disabled', false);
                      }
                    });
                  }
                });
              }
            });
          }
        });
      }

      function onCatClick() {
        $('#filter-btn').prop('disabled', false);
      }

      function onFilterClick() {
        var selections = $("#sel-cat").val();
        sels = "";
        for (var s = 0; s < selections.length; s++) {
          sels = sels + encodeURIComponent(encodeURIComponent(selections[s])) + "&A&";
        }
        sels = sels.substring(0, sels.length - 3);

        u = "";
        if (sels.length > 0)
          u = `/api/v1.0/filtered-businesses/${state}/${city}/${zip}/${sels}`;
        else
          u = `/api/v1.0/businesses/${state}/${city}/${zip}`;

        <!-- Send to endpoint -->
        $.ajax({
          url: u,
          success: function (data, status) {
            <!-- Use response to populate TABLE -->
            d = "";
            for (var i = 0; i < data.businesses.length; i++){
              td = "";
              for (var j = 0; j < data.businesses[i].length; j++){
                td = td + `<td>${data.businesses[i][j]}</td>`;
              }
              d = d + `
                <tr>
                  <th scope="row">${i+1}</th>
                  ${td}
                </tr>
              `;
            }
            $('#b-table').html(d);

            $('#filter-btn').prop('disabled', true);
            $('#clear-btn').prop('disabled', false);
          }
        });
      }

      function onClearClick() {
        $("#sel-cat").val([]);

        <!-- Send to endpoint -->
        $.ajax({
          url: `/api/v1.0/businesses/${state}/${city}/${zip}`,
          success: function (data, status) {
            <!-- Use response to populate TABLE -->
            d = "";
            for (var i = 0; i < data.businesses.length; i++){
              td = "";
              for (var j = 0; j < data.businesses[i].length; j++){
                td = td + `<td>${data.businesses[i][j]}</td>`;
              }
              d = d + `
                <tr>
                  <th scope="row">${i+1}</th>
                  ${td}
                </tr>
              `;
            }
            $('#b-table').html(d);

            $('#filter-btn').prop('disabled', true);
            $('#clear-btn').prop('disabled', true);
          }
        });
      }

      function onRefreshClick() {
        <!-- Send to endpoint -->
        $.ajax({
          url: `/api/v1.0/expensive/${state}/${city}/${zip}`,
          success: function (data, status) {
            <!-- Use response to populate TABLE -->
            d = "";
            for (var i = 0; i < data.expensive.length; i++){
              td = "";
              for (var j = 0; j < data.expensive[i].length; j++){
                td = td + `<td>${data.expensive[i][j]}</td>`;
              }
              d = d + `
                <tr>
                  ${td}
                </tr>
              `;
            }
            $('#expensive').html(d);

            <!-- Send to endpoint -->
            $.ajax({
              url: `/api/v1.0/popular/${state}/${city}/${zip}`,
              success: function (data, status) {
                <!-- Use response to populate TABLE -->
                d = "";
                for (var i = 0; i < data.popular.length; i++){
                  td = "";
                  for (var j = 0; j < data.popular[i].length; j++){
                    td = td + `<td>${data.popular[i][j]}</td>`;
                  }
                  d = d + `
                    <tr>
                      ${td}
                    </tr>
                  `;
                }
                $('#popular').html(d);

                <!-- Send to endpoint -->
                $.ajax({
                  url: `/api/v1.0/successful/${state}/${city}/${zip}`,
                  success: function (data, status) {
                    <!-- Use response to populate TABLE -->
                    d = "";
                    for (var i = 0; i < data.successful.length; i++){
                      td = "";
                      for (var j = 0; j < data.successful[i].length; j++){
                        td = td + `<td>${data.successful[i][j]}</td>`;
                      }
                      d = d + `
                        <tr>
                          ${td}
                        </tr>
                      `;
                    }
                    $('#successful').html(d);
                  }
                });
              }
            });
          }
        });

      }
    </script>
  </body>
</html>
